name: Tests

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  test:
    name: Run Tests
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, ubuntu-22.04, macos-latest]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y jq rsync

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install jq rsync bash
          # Add Homebrew's bash to path (bash 5.x)
          echo "$(brew --prefix)/bin" >> $GITHUB_PATH
          
      - name: Verify bash version
        run: |
          echo "Bash version: $BASH_VERSION"
          bash --version
          
      - name: Make scripts executable
        run: |
          chmod +x cust-run-config.sh
          chmod +x bash/*.sh
          chmod +x tests/*.sh

      - name: Run tests
        shell: bash
        run: |
          # On macOS, explicitly use Homebrew's bash
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            export PATH="$(brew --prefix)/bin:$PATH"
          fi
          bash ./tests/run-tests.sh
        env:
          CI: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.os }}
          path: |
            tests/*.log
          retention-days: 7

  shellcheck:
    name: ShellCheck Linting
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install ShellCheck
        run: sudo apt-get install -y shellcheck

      - name: Run ShellCheck
        run: |
          echo "::group::Checking cust-run-config.sh"
          shellcheck -x -S warning cust-run-config.sh || true
          echo "::endgroup::"
          
          echo "::group::Checking bash/*.sh"
          shopt -s nullglob
          for script in bash/*.sh; do
            echo "Checking $script..."
            shellcheck -x -S warning "$script" || true
          done
          echo "::endgroup::"
          
          echo "::group::Checking bash/lib/*.sh"
          for script in bash/lib/*.sh; do
            echo "Checking $script..."
            shellcheck -x -S warning "$script" || true
          done
          echo "::endgroup::"

      - name: ShellCheck Report
        run: |
          echo "## ShellCheck Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Count issues per severity
          errors=$(shellcheck -x -f gcc bash/*.sh bash/lib/*.sh cust-run-config.sh 2>/dev/null | grep -c "error:" || echo "0")
          warnings=$(shellcheck -x -f gcc bash/*.sh bash/lib/*.sh cust-run-config.sh 2>/dev/null | grep -c "warning:" || echo "0")
          notes=$(shellcheck -x -f gcc bash/*.sh bash/lib/*.sh cust-run-config.sh 2>/dev/null | grep -c "note:" || echo "0")
          
          echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Errors   | $errors |" >> $GITHUB_STEP_SUMMARY
          echo "| Warnings | $warnings |" >> $GITHUB_STEP_SUMMARY
          echo "| Notes    | $notes |" >> $GITHUB_STEP_SUMMARY

  json-validation:
    name: Validate JSON Files
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Validate JSON files
        run: |
          echo "## JSON Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for json_file in config/*.json; do
            echo "Validating $json_file..."
            if jq empty "$json_file" 2>/dev/null; then
              echo "âœ… $json_file is valid" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ $json_file is INVALID" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          done

  syntax-check:
    name: Bash Syntax Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check bash syntax
        run: |
          echo "## Bash Syntax Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          errors=0
          for script in cust-run-config.sh bash/*.sh bash/lib/*.sh; do
            if bash -n "$script" 2>/dev/null; then
              echo "âœ… $script" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ $script - SYNTAX ERROR" >> $GITHUB_STEP_SUMMARY
              bash -n "$script"
              ((errors++)) || true
            fi
          done
          
          if [ $errors -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**$errors script(s) with syntax errors!**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**All scripts have valid syntax!**" >> $GITHUB_STEP_SUMMARY

  completions-check:
    name: Validate Shell Completions
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Bash completions syntax
        run: |
          echo "Checking Bash completions..."
          bash -n completions/autovault.bash

      - name: Check Zsh completions
        run: |
          echo "Checking Zsh completions file exists..."
          test -f completions/_autovault

  export-check:
    name: Validate Export Command
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Make scripts executable
        run: |
          chmod +x cust-run-config.sh
          chmod +x bash/*.sh

      - name: Check Export-Vault.sh exists
        run: test -f bash/Export-Vault.sh

      - name: Check Export-Vault.sh syntax
        run: bash -n bash/Export-Vault.sh

      - name: Check export help
        run: |
          ./cust-run-config.sh export --help | grep -qi "pdf"
          ./cust-run-config.sh export --help | grep -qi "html"
          ./cust-run-config.sh export --help | grep -qi "markdown"

      - name: Export Check Summary
        run: |
          echo "## ðŸ“„ Export Command Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Script exists | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Syntax valid | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Help works | âœ… |" >> $GITHUB_STEP_SUMMARY

  packaging-check:
    name: Validate Packaging Files
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check packaging structure
        run: |
          test -d packaging
          test -d packaging/debian
          test -d packaging/rpm

      - name: Validate build script
        run: |
          test -f packaging/build-packages.sh
          test -x packaging/build-packages.sh
          bash -n packaging/build-packages.sh

      - name: Validate Debian files
        run: |
          test -f packaging/debian/control
          test -f packaging/debian/changelog
          test -f packaging/debian/rules
          test -f packaging/debian/copyright
          grep -q "Package: autovault" packaging/debian/control
          grep -q "Depends:" packaging/debian/control

      - name: Validate RPM spec
        run: |
          test -f packaging/rpm/autovault.spec
          grep -q "Name:.*autovault" packaging/rpm/autovault.spec
          grep -q "Requires:" packaging/rpm/autovault.spec

      - name: Test build script help
        run: ./packaging/build-packages.sh help | grep -qiE "deb|rpm"

      - name: Packaging Check Summary
        run: |
          echo "## ðŸ“¦ Packaging Files Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build script | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Debian control | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Debian changelog | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Debian rules | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| RPM spec | âœ… |" >> $GITHUB_STEP_SUMMARY

  build-deb:
    name: Test DEB Build
    runs-on: ubuntu-latest
    needs: [packaging-check]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev fakeroot

      - name: Make scripts executable
        run: chmod +x packaging/build-packages.sh

      - name: Build DEB package
        run: ./packaging/build-packages.sh deb

      - name: Verify DEB package
        run: |
          test -f dist/autovault_*.deb
          dpkg-deb --info dist/autovault_*.deb

      - name: Upload DEB artifact
        uses: actions/upload-artifact@v4
        with:
          name: deb-package
          path: dist/*.deb
          retention-days: 7

      - name: DEB Build Summary
        run: |
          echo "## ðŸ§ DEB Package Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Package built successfully!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          dpkg-deb --info dist/autovault_*.deb >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    needs: [test]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Make scripts executable
        run: |
          chmod +x tests/coverage.sh
          chmod +x bash/*.sh
          chmod +x bash/lib/*.sh

      - name: Generate coverage report
        run: |
          ./tests/coverage.sh --json
          ./tests/coverage.sh --html

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

      - name: Coverage Summary
        run: |
          coverage=$(cat coverage/coverage.txt)
          
          echo "## ðŸ“Š Code Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Overall Coverage: ${coverage}%**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$coverage" -ge 80 ]; then
            echo "ðŸŸ¢ Coverage is excellent!" >> $GITHUB_STEP_SUMMARY
          elif [ "$coverage" -ge 50 ]; then
            echo "ðŸŸ¡ Coverage is acceptable but could be improved" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸ”´ Coverage needs improvement" >> $GITHUB_STEP_SUMMARY
          fi

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [test, shellcheck, json-validation, syntax-check, completions-check, export-check, packaging-check, build-deb, coverage]
    if: always()
    
    steps:
      - name: Generate Summary
        run: |
          echo "# AutoVault CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ShellCheck | ${{ needs.shellcheck.result == 'success' && 'âœ… Passed' || 'âš ï¸ Issues' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| JSON Validation | ${{ needs.json-validation.result == 'success' && 'âœ… Valid' || 'âŒ Invalid' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Syntax Check | ${{ needs.syntax-check.result == 'success' && 'âœ… Valid' || 'âŒ Errors' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Completions | ${{ needs.completions-check.result == 'success' && 'âœ… Valid' || 'âš ï¸ Issues' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Export Check | ${{ needs.export-check.result == 'success' && 'âœ… Valid' || 'âŒ Errors' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Packaging Check | ${{ needs.packaging-check.result == 'success' && 'âœ… Valid' || 'âŒ Errors' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| DEB Build | ${{ needs.build-deb.result == 'success' && 'âœ… Built' || 'âš ï¸ Issues' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Coverage | ${{ needs.coverage.result == 'success' && 'âœ… Generated' || 'âš ï¸ Issues' }} |" >> $GITHUB_STEP_SUMMARY
