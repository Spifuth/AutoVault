#compdef cust-run-config.sh cust-run-config autovault av vault custrun
#===============================================================================
#
#  AUTOVAULT - Zsh Completion
#
#===============================================================================
#
#  DESCRIPTION:    Zsh completion script for AutoVault CLI.
#                  Provides intelligent tab-completion with descriptions.
#
#  INSTALLATION:   
#                  # Option 1: Add to fpath in your .zshrc
#                  fpath=(/path/to/completions $fpath)
#                  autoload -Uz compinit && compinit
#
#                  # Option 2: System-wide (Linux)
#                  sudo cp _autovault /usr/share/zsh/site-functions/
#
#                  # Option 3: Oh-My-Zsh custom
#                  cp _autovault ~/.oh-my-zsh/completions/
#
#===============================================================================

_autovault() {
    local curcontext="$curcontext" state line
    typeset -A opt_args
    
    # Global options
    local -a global_opts
    global_opts=(
        '-v[Enable verbose output]'
        '--verbose[Enable verbose output]'
        '-q[Only show errors]'
        '--quiet[Only show errors]'
        '--silent[Suppress all output]'
        '--no-color[Disable colored output]'
        '--dry-run[Preview changes without applying]'
        '--diff[Show what would change]'
        '-h[Show help]'
        '--help[Show help]'
        '--version[Show version information]'
    )
    
    _arguments -C \
        $global_opts \
        '1: :->command' \
        '*: :->args'
    
    case "$state" in
        command)
            local -a commands
            commands=(
                'config:Interactive configuration wizard'
                'validate:Validate configuration file'
                'status:Show current status'
                'stats:Show detailed statistics dashboard'
                'diff:Show diff of expected vs actual state'
                'structure:Create folder structure in vault'
                'templates:Manage templates (sync/apply/export/preview)'
                'test:Verify vault structure'
                'cleanup:Remove vault structure (dangerous!)'
                'customer:Manage customers (add/remove/list/export/import/clone)'
                'section:Manage sections (add/remove/list)'
                'backup:Manage backups (create/list/restore/cleanup)'
                'archive:Archive a customer (zip + optional remove)'
                'export:Export vault/customer to PDF/HTML/Markdown'
                'git-sync:Automatic git synchronization (commit/push)'
                'init:Initialize new vault from scratch'
                'vault:Obsidian setup (init/plugins/check/hub)'
                'remote:Remote vault sync via SSH (push/pull)'
                'doctor:Run diagnostics (config, structure, perms)'
                'search:Search across all customers/notes'
                'hooks:Manage automation hooks (list/init/test)'
                'completions:Install shell completions (bash/zsh)'
                'alias:Create system alias (autovault, av, etc.)'
                'requirements:Check/install dependencies'
                'theme:Configure color theme (dark/light/auto)'
                'demo:UI components demo (progress/spinner/etc.)'
                'help:Show help for a command'
            )
            _describe 'command' commands
            ;;
        args)
            case "${line[1]}" in
                customer|customers)
                    _autovault_customer
                    ;;
                section|sections)
                    _autovault_section
                    ;;
                backup|backups)
                    _autovault_backup
                    ;;
                templates|apply)
                    _autovault_templates
                    ;;
                vault)
                    _autovault_vault
                    ;;
                hooks)
                    _autovault_hooks
                    ;;
                remote)
                    _autovault_remote
                    ;;
                completions)
                    _autovault_completions_cmd
                    ;;
                alias)
                    _autovault_alias_cmd
                    ;;
                init)
                    _autovault_init
                    ;;
                doctor|diagnose|check)
                    _autovault_doctor
                    ;;
                search|find|grep)
                    _autovault_search
                    ;;
                archive)
                    _autovault_archive
                    ;;
                export)
                    _autovault_export
                    ;;
                git-sync|gitsync|sync)
                    _autovault_git_sync
                    ;;
                theme)
                    _autovault_theme
                    ;;
                demo)
                    _autovault_demo
                    ;;
                *)
                    _arguments '--help[Show help]'
                    ;;
            esac
            ;;
    esac
}

_autovault_customer() {
    local -a subcmds
    subcmds=(
        'add:Add a new customer'
        'remove:Remove a customer'
        'list:List all customers'
        'export:Export customer to archive'
        'import:Import customer from archive'
        'clone:Clone an existing customer'
    )
    
    _arguments \
        '1: :->subcmd' \
        '*: :->args'
    
    case "$state" in
        subcmd)
            _describe 'customer command' subcmds
            ;;
        args)
            # Complete with existing customer IDs
            local -a ids
            ids=(${(f)"$(_autovault_get_customer_ids)"})
            [[ -n "$ids" ]] && _describe 'customer ID' ids
            ;;
    esac
}

_autovault_section() {
    local -a subcmds
    subcmds=(
        'add:Add a new section'
        'remove:Remove a section'
        'list:List all sections'
    )
    
    _arguments \
        '1: :->subcmd' \
        '*: :->args'
    
    case "$state" in
        subcmd)
            _describe 'section command' subcmds
            ;;
        args)
            # Complete with existing sections
            local -a sections
            sections=(${(f)"$(_autovault_get_sections)"})
            [[ -n "$sections" ]] && _describe 'section name' sections
            ;;
    esac
}

_autovault_backup() {
    local -a subcmds
    subcmds=(
        'create:Create a new backup'
        'list:List all backups'
        'restore:Restore from a backup'
        'cleanup:Clean old backups'
    )
    
    _arguments \
        '1: :->subcmd' \
        '*: :->args'
    
    case "$state" in
        subcmd)
            _describe 'backup command' subcmds
            ;;
        args)
            case "${line[2]}" in
                restore|cleanup)
                    # Complete with backup files
                    local -a backups
                    backups=(${(f)"$(_autovault_get_backups)"})
                    [[ -n "$backups" ]] && _describe 'backup file' backups
                    ;;
            esac
            ;;
    esac
}

_autovault_templates() {
    local -a subcmds
    subcmds=(
        'sync:Sync templates from config to vault'
        'apply:Apply templates to existing structure'
        'export:Export templates from vault to config'
        'preview:Preview a template before applying'
    )
    
    _arguments \
        '1: :->subcmd' \
        '*: :->args'
    
    case "$state" in
        subcmd)
            _describe 'templates command' subcmds
            ;;
        args)
            case "${line[2]}" in
                preview)
                    # Complete with template names
                    local -a templates
                    templates=(${(f)"$(_autovault_get_templates)"})
                    [[ -n "$templates" ]] && _describe 'template name' templates
                    ;;
            esac
            ;;
    esac
}

_autovault_vault() {
    local -a subcmds
    subcmds=(
        'init:Initialize Obsidian vault'
        'plugins:Install community plugins'
        'check:Check vault configuration'
        'hub:Open Obsidian plugin hub'
    )
    _describe 'vault command' subcmds
}

_autovault_hooks() {
    local state
    _arguments -C \
        '--help[Show help]' \
        '1: :->subcmd' \
        '*: :->args'
    
    case "$state" in
        subcmd)
            local -a subcmds
            subcmds=(
                'list:List available hooks'
                'init:Initialize hooks directory with examples'
                'test:Test a specific hook'
            )
            _describe 'hooks command' subcmds
            ;;
        args)
            case "${line[2]}" in
                test)
                    # Complete with hook names
                    local -a hooks
                    hooks=(
                        'pre-customer-remove:Before removing a customer'
                        'post-customer-remove:After removing a customer'
                        'post-templates-apply:After applying templates'
                        'on-error:When any error occurs'
                    )
                    _describe 'hook name' hooks
                    ;;
            esac
            ;;
    esac
}

_autovault_remote() {
    local state
    _arguments -C \
        '--help[Show help]' \
        '1: :->subcmd' \
        '*: :->args'
    
    case "$state" in
        subcmd)
            local -a subcmds
            subcmds=(
                'list:List configured remotes'
                'init:Initialize remotes configuration'
                'add:Add a new remote'
                'remove:Remove a remote'
                'test:Test remote connection'
                'push:Push vault to remote'
                'pull:Pull vault from remote'
                'status:Compare local and remote'
            )
            _describe 'remote command' subcmds
            ;;
        args)
            case "${line[2]}" in
                remove|rm|test|push|pull|status)
                    # Complete with remote names
                    local -a remotes
                    remotes=(${(f)"$(_autovault_get_remotes)"})
                    [[ -n "$remotes" ]] && _describe 'remote name' remotes
                    ;;
            esac
            ;;
    esac
}

_autovault_completions_cmd() {
    local -a subcmds
    subcmds=(
        'install:Install shell completions'
        'uninstall:Remove installed completions'
        'status:Show completion installation status'
    )
    
    _arguments \
        '1: :->subcmd' \
        '*: :->args'
    
    case "$state" in
        subcmd)
            _describe 'completions command' subcmds
            ;;
        args)
            case "${line[2]}" in
                install)
                    local -a shells opts
                    shells=(
                        'bash:Install Bash completions'
                        'zsh:Install Zsh completions'
                        'all:Install for all shells'
                    )
                    opts=(
                        '--user[Install for current user only (default)]'
                        '--system[Install system-wide (requires sudo)]'
                    )
                    _describe 'shell' shells
                    _arguments $opts
                    ;;
                uninstall)
                    local -a shells
                    shells=(
                        'bash:Remove Bash completions'
                        'zsh:Remove Zsh completions'
                        'all:Remove all completions'
                    )
                    _describe 'shell' shells
                    ;;
            esac
            ;;
    esac
}

_autovault_alias_cmd() {
    local -a subcmds
    subcmds=(
        'install:Create system alias or symlink'
        'uninstall:Remove installed alias'
        'status:Show alias installation status'
    )
    
    _arguments \
        '1: :->subcmd' \
        '*: :->args'
    
    case "$state" in
        subcmd)
            _describe 'alias command' subcmds
            ;;
        args)
            case "${line[2]}" in
                install)
                    local -a names opts
                    names=(
                        'autovault:Full name (default)'
                        'av:Short and quick'
                        'vault:Alternative name'
                        'custrun:Descriptive name'
                    )
                    opts=(
                        '--name=[Custom alias name]:alias name:(autovault av vault custrun)'
                        '--method=[Installation method]:method:(symlink alias)'
                        '--user[Install for current user only (default)]'
                        '--system[Install system-wide (requires sudo)]'
                    )
                    _describe 'alias name' names
                    _arguments $opts
                    ;;
                uninstall)
                    local -a opts
                    opts=(
                        '--all[Remove all installed aliases]'
                        '--name=[Alias name to remove]:alias name:(autovault av vault custrun)'
                    )
                    _arguments $opts
                    ;;
            esac
            ;;
    esac
}

_autovault_init() {
    _arguments \
        '--path=[Vault path]:directory:_files -/' \
        '--profile=[Use profile template]:profile:(minimal pentest audit bugbounty)' \
        '--force[Overwrite existing configuration]' \
        '--no-structure[Skip creating initial folder structure]' \
        '--help[Show help]'
}

_autovault_doctor() {
    _arguments \
        '--fix[Attempt to fix issues automatically]' \
        '--verbose[Show detailed diagnostic information]' \
        '--json[Output results as JSON]' \
        '--help[Show help]'
}

_autovault_search() {
    _arguments \
        '-c[Search in specific customer]:customer ID:($(_autovault_get_customer_ids))' \
        '--customer=[Search in specific customer]:customer ID:($(_autovault_get_customer_ids))' \
        '-s[Search in specific section]:section:($(_autovault_get_sections))' \
        '--section=[Search in specific section]:section:($(_autovault_get_sections))' \
        '-t[Filter by file type]:type:(md txt all json yaml)' \
        '--type=[Filter by file type]:type:(md txt all json yaml)' \
        '-r[Treat query as regex]' \
        '--regex[Treat query as regex]' \
        '-i[Case-sensitive search]' \
        '--case-sensitive[Case-sensitive search]' \
        '-n[Show only matching filenames]' \
        '--names-only[Show only matching filenames]' \
        '-C[Lines of context]:lines:' \
        '--context=[Lines of context]:lines:' \
        '-m[Maximum results]:max:' \
        '--max=[Maximum results]:max:' \
        '--json[Output as JSON]' \
        '--help[Show help]' \
        '*:query:'
}

_autovault_export() {
    local state
    _arguments -C \
        '--help[Show help]' \
        '1: :->subcmd' \
        '*: :->args'
    
    case "$state" in
        subcmd)
            local -a subcmds
            subcmds=(
                'pdf:Export to PDF format'
                'html:Export to HTML format'
                'markdown:Export to single Markdown file'
                'report:Generate client report'
            )
            _describe 'export command' subcmds
            ;;
        args)
            case "${line[2]}" in
                pdf|html|markdown|report)
                    local -a targets opts
                    targets=(
                        'customer:Export specific customer'
                        'section:Export specific section'
                        'vault:Export entire vault'
                        'file:Export single file'
                    )
                    opts=(
                        '-o[Output file path]:file:_files'
                        '--output=[Output file path]:file:_files'
                        '-t[Report template]:template:(default pentest audit summary)'
                        '--template=[Report template]:template:(default pentest audit summary)'
                        '--no-toc[Disable table of contents]'
                        '--no-metadata[Disable metadata header]'
                        '--page-size=[PDF page size]:size:(A4 Letter Legal A3)'
                        '--css=[Custom CSS file]:file:_files -g "*.css"'
                        '--title=[Document title]:title:'
                        '--author=[Document author]:author:'
                    )
                    _describe 'target' targets
                    _arguments $opts
                    ;;
                customer)
                    local -a ids
                    ids=(${(f)"$(_autovault_get_customer_ids)"})
                    [[ -n "$ids" ]] && _describe 'customer ID' ids
                    ;;
            esac
            ;;
    esac
}

_autovault_archive() {
    _arguments \
        '-r[Remove after archiving]' \
        '--remove[Remove after archiving]' \
        '-o[Output path]:file:_files' \
        '--output=[Output path]:file:_files' \
        '-f[Archive format]:format:(zip tar tar.gz tar.bz2)' \
        '--format=[Archive format]:format:(zip tar tar.gz tar.bz2)' \
        '--no-compress[Create uncompressed tar]' \
        '-e[Encrypt archive (zip only)]' \
        '--encrypt[Encrypt archive (zip only)]' \
        '--force[Overwrite existing archive]' \
        '--help[Show help]' \
        '*:customer ID:($(_autovault_get_customer_ids))'
}

# Theme subcommands
_autovault_theme() {
    local -a subcmds
    subcmds=(
        'status:Show current theme settings'
        'set:Set theme (dark/light/auto)'
        'preview:Preview all available themes'
        'config:Interactive theme configuration'
        'reset:Reset to default settings'
    )
    
    case "${words[2]}" in
        set)
            local -a themes
            themes=(
                'dark:Optimized for dark terminal backgrounds'
                'light:Optimized for light terminal backgrounds'
                'auto:Auto-detect based on terminal settings'
            )
            _describe 'theme' themes
            ;;
        *)
            _describe 'subcommand' subcmds
            ;;
    esac
}

# Demo subcommands
_autovault_demo() {
    local -a components
    components=(
        'all:Run all demos'
        'progress:Progress bar demonstration'
        'spinner:Spinner/loading animations'
        'theme:Theme switching preview'
        'menu:Interactive menu selection'
        'notify:Desktop notifications'
        'box:Box and section formatting'
    )
    _describe 'component' components
}

# Git-sync subcommands
_autovault_git_sync() {
    local -a subcmds
    subcmds=(
        'status:Show git sync status and pending changes'
        'now:Sync immediately (commit + push)'
        'sync:Sync immediately (commit + push)'
        'watch:Watch for changes and sync continuously'
        'config:Configure git-sync settings'
        'enable:Enable auto-sync (cron or systemd)'
        'disable:Disable auto-sync'
        'log:Show sync history'
        'init:Initialize vault as git repository'
    )
    
    _arguments \
        '1: :->subcmd' \
        '*: :->args' \
        '--quiet[Suppress output]' \
        '-q[Suppress output]' \
        '--help[Show help]'
    
    case "$state" in
        subcmd)
            _describe 'git-sync command' subcmds
            ;;
        args)
            case "${words[2]}" in
                enable)
                    local -a methods
                    methods=(
                        'cron:Use crontab for periodic sync'
                        'systemd:Use systemd user timer'
                    )
                    _describe 'method' methods
                    ;;
                watch)
                    _arguments \
                        '--interval[Sync interval in seconds]:seconds:(60 120 300 600)' \
                        '-i[Sync interval in seconds]:seconds:(60 120 300 600)'
                    ;;
                log|logs|history)
                    _arguments '1:lines:(10 20 50 100)'
                    ;;
                init)
                    _arguments '1:remote URL:'
                    ;;
            esac
            ;;
    esac
}

# Helper functions to get dynamic values
_autovault_get_customer_ids() {
    local config_file="${CONFIG_JSON:-./config/cust-run-config.json}"
    [[ -f "$config_file" ]] && jq -r '.CustomerIds[]? // empty' "$config_file" 2>/dev/null
}

_autovault_get_sections() {
    local config_file="${CONFIG_JSON:-./config/cust-run-config.json}"
    [[ -f "$config_file" ]] && jq -r '.Sections[]? // empty' "$config_file" 2>/dev/null
}

_autovault_get_backups() {
    local backup_dir="./backups"
    [[ -d "$backup_dir" ]] && find "$backup_dir" -maxdepth 1 -name "*.json" -printf "%f\n" 2>/dev/null | sed 's/\.json$//'
}

_autovault_get_templates() {
    local config_file="${CONFIG_JSON:-./config/templates.json}"
    [[ -f "$config_file" ]] && jq -r 'keys[]' "$config_file" 2>/dev/null
}

_autovault_get_remotes() {
    local config_file="${REMOTES_JSON:-./config/remotes.json}"
    [[ -f "$config_file" ]] && jq -r '.remotes | keys[]' "$config_file" 2>/dev/null
}

_autovault "$@"
